# Карабельников Степан Иванович
**Группа:** БПИ234

# Требования безопасности + Модель угроз

## 1. Описание проекта

### 1.1 Суть проекта OKR Tracker

**OKR Tracker** — это учебный backend‑сервис, реализованный на **FastAPI**, предназначенный для управления системой целей и ключевых результатов (*Objectives and Key Results, OKR*).
Приложение позволяет организациям, командам и отдельным пользователям формулировать цели, декомпозировать их на измеримые результаты и отслеживать прогресс выполнения.

### 1.2 Основная функциональность

**Работа с целями (Objectives)**  
- создание, получение, удаление целей и расчёт прогресса выполнения на основе связанных Key Results.

**Работа с ключевыми результатами (Key Results)**  
- добавление, обновление и удаление результатов, связанных с конкретной целью;  
- автоматическая проверка корректности значений (`current_value < target_value` при создании).

**Расчёт прогресса**  
- эндпоинт `GET /objectives/{obj_id}/progress` вычисляет процент выполнения цели по сумме всех **Key Results**.

**Безопасная загрузка файлов (Files)**  
- эндпоинт `POST /files/upload` позволяет загружать изображения (например, иконки целей или отчётов).  
- механизм реализован через функцию `secure_save_upload`, которая:
  - проверяет размер файла ≤ **5 МБ**;
  - определяет тип по *magic‑bytes* (только `jpeg`, `png`, `gif`);
  - генерирует безопасное **UUID‑имя** и сохраняет файл без возможности *path traversal*;
  - возвращает JSON‑ответ с именем загруженного файла.

**Логирование и обработка ошибок**  
- все запросы фиксируются в access‑логе,  
- исключения централизованно перехватываются через `ExceptionLoggingMiddleware`, который маскирует PII‑данные и возвращает ответ в формате **RFC 7807**.

### 1.3 Хранение и структура данных

- база данных — **SQLite**;  
- ORM‑модель — **SQLAlchemy** с каскадным удалением `Objective → KeyResults`;  
- валидация и сериализация — **Pydantic v2**;  
- все публичные эндпоинты снабжены `response_model` для предотвращения утечек данных.

### 1.4 Swagger‑интерфейс

**Swagger UI** (`/docs`) отображает три логических блока API:
1. **Objectives** — операции с целями;
2. **Key Results** — управление ключевыми результатами;
3. **Files** — загрузка и валидация изображений.

Такое разделение повышает прозрачность API и позволяет легко тестировать endpoints, включая сценарии безопасности.

---

## 2. Нефункциональные требования безопасности (NFR)

### 2.1 Цель

Нефункциональные требования безопасности определяют измеримые критерии защиты, надёжности и качества кода для проекта **OKR Tracker**.
Они обеспечивают трассировку между архитектурными решениями, тестами и DevSecOps‑практиками.

### 2.2 Реализованные требования

| ID     | Название                  | Реализация в коде                                                                 | Проверка                                    |
|--------|---------------------------|------------------------------------------------------------------------------------|---------------------------------------------|
| NFR-01 | Производительность API    | FastAPI эндпоинты оптимизированы, без тяжёлых операций; запросы ≤ 500 мс на 95 %  | `pytest` измеряет время; CI: coverage step  |
| NFR-02 | Контроль ошибок           | Все исключения логируются централизованно (`ExceptionLoggingMiddleware`), ответ RFC 7807 | `pytest`, ручные запросы 4xx/5xx      |
| NFR-03 | Ограничение входных данных| `BodySizeLimitMiddleware` возвращает **413** при > 1 МБ                            | `pytest` → `test_payload_too_large`         |
| NFR-04 | Централизованная обработка ошибок | Исключения логируются в `error.log`, PII‑данные маскируются                 | Тесты и проверка содержимого логов          |
| NFR-05 | Безопасность БД           | Используется только SQLAlchemy ORM, без raw SQL; все запросы типизированы          | Static analysis + code review                |
| NFR-06 | Логирование запросов      | Middleware `log_requests` пишет access‑логи с кодами ответов                        | Проверка в stdout/логах                     |
| NFR-07 | Валидация ввода           | Все входные данные проходят **Pydantic**‑валидацию                                  | `pytest`, негативные сценарии               |
| NFR-08 | Покрытие тестами ≥ 80 %   | Автоматическая проверка покрытия в CI (`pytest --cov --cov-fail-under=80`)         | GitHub Actions → step “Run tests with coverage” |

### 2.3 Трассируемость требований

Для обеспечения прозрачности реализации требований безопасности создана **матрица трассируемости** (Traceability Matrix), отражающая взаимосвязь между:
- нефункциональными требованиями **(NFR‑01…NFR‑08)**;
- практиками **DevSecOps (P01–P08)**;
- задачами в **GitHub Issues (S‑01…S‑08)**.

Матрица показывает, на каком этапе ЖЦ проекта каждое требование было реализовано, протестировано и подтверждено артефактами (тестами, CI, кодом).

**P01–P02 (репозиторий и CI)**  
Реализованы практики базовой инженерной гигиены: защита ветки `main`, настройка GitHub Actions, автоматический запуск `pytest`, `ruff`, `mypy` и `bandit`.  
Это обеспечивает выполнение **NFR‑06** (логирование) и **NFR‑08** (покрытие тестами ≥ 80%).

**P03 (Security NFR)**  
Сформулированы измеримые NFR и приёмочные сценарии в формате **BDD**.  
Все требования документированы в `NFR.md`, проверяются тестами из каталога `tests/`.

**P04 (Threat Modeling)**  
Выполнены: контекст системы, DFD‑диаграммы, STRIDE‑таблицы угроз и риск‑оценка.  
Это обеспечивает выполнение **NFR‑03**, **NFR‑04**, **NFR‑05** и **NFR‑07**.

**P05–P06 (Secure Coding)**  
Реализованы middleware и тесты, обеспечивающие защиту от ошибок, инъекций и невалидных данных:  
`BodySizeLimitMiddleware`, `ExceptionLoggingMiddleware`, `ApiKeyGateMiddleware`, а также негативные тесты `test_p06_negative_cases.py` и `test_p06_c3_masking.py`.

**P07 (Container Hardening)**  
Контейнеризация приложения выполнена через Docker **multi‑stage build**.  
Используются non‑root образы, минимальные зависимости и проверка **Trivy** (IaC‑политики).  
Это покрывает **NFR‑01**, **NFR‑02** и **NFR‑06**.

**P08 (CI/CD Minimal)**  
Настроен CI/CD‑пайплайн с этапами тестирования, линтинга, статического анализа и проверки покрытия.  
Подтверждение — шаг *Run tests with coverage* в `.github/workflows/ci.yml` (покрытие ≥ 80%).

### 2.4 Приёмочные сценарии (BDD Acceptance Scenarios)

Цель — подтвердить выполнение ключевых NFR (NFR‑01…NFR‑05) посредством приёмочных сценариев в формате **BDD (Given–When–Then)**.

| NFR    | Проверяемый аспект                       | Компонент                     | Тест / Артефакт                     | Результат |
|--------|------------------------------------------|-------------------------------|-------------------------------------|-----------|
| NFR-01 | Время ответа (≤ 500 мс, p95)             | FastAPI endpoints             | `test_api_performance_p95`          | Passed    |
| NFR-02 | Ошибки ≤ 1%                              | CRUD `/key_results`           | `test_error_rate_under_1_percent`   | Passed    |
| NFR-03 | Ограничение размера тела                 | `BodySizeLimitMiddleware`     | `test_payload_too_large`            | Passed    |
| NFR-04 | Маскирование ошибок, RFC 7807            | `ExceptionLoggingMiddleware`  | `test_exception_logging`            | Passed    |
| NFR-05 | ORM‑only, без raw SQL                    | SQLAlchemy ORM                | `test_no_raw_sql_usage`             | Passed    |

---

## 3. Модель угроз (Threat Model)

### 3.1 Цель и контекст

**Цель.** Определить и стандартизировать подход к выявлению, оценке и обработке угроз безопасности для сервиса **OKR Tracker**, минимизировать риски для данных пользователей и стабильности сервиса.

**Контекст системы.**  
- **Тип приложения:** RESTful‑API на FastAPI.  
- **Клиенты:** веб‑интерфейсы/скрипты разработчиков, CI/CD‑агенты.  
- **Хранилище:** SQLite (локально), возможная миграция в облачную СУБД.  
- **Артефакты безопасности:** API‑ключ/токен для защищённых операций (через `ApiKeyGateMiddleware`), централизованное логирование и маскирование PII, ограничения размера запроса.  
- **Границы доверия (Trust Boundaries):**
  1) внешние клиенты ↔ API‑шлюз/приложение;  
  2) приложение ↔ СУБД;  
  3) приложение ↔ файловая подсистема (загрузка изображений).

**Активы (assets).**  
- данные целей и KR, файлы (изображения), логи (могут содержать метаданные о пользователях), конфигурации CI/CD.

**Предположения и ограничения.**  
- транспортный уровень защищён (HTTPS);  
- админ‑доступ к окружению ограничен;  
- секреты хранятся вне репозитория;  
- прямой доступ к БД извне отсутствует.

**Методика.**  
- STRIDE по DFD (спуфинг, тамперинг, отказ от ответственности, раскрытие, отказ в обслуживании, повышение привилегий);  
- приоритизация по вероятности/влиянию (OWASP‑подход);  
- обработка: устранение, смягчение, перенос, принятие.

*(Дополнительно: разделы 3.2–3.4 можно расширить DFD, таблицами STRIDE и планом мер.)*

